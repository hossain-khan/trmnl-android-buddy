name: APK Size Analysis with Diffuse

on:
  pull_request:
    branches: [ "main" ]
    # No path filters - this is a required check and must always run
    # We'll check changed files within the job and skip heavy work if needed

jobs:
  diffuse:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # Required to post comments

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Need full history to detect changed files

      - name: Check if relevant files changed
        id: changed-files
        run: |
          # Get the list of changed files between base and head
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check if any relevant files changed (Kotlin, Gradle, resources, manifests, etc.)
          if echo "$CHANGED_FILES" | grep -qE '\.(kt|kts)$|gradle\.properties|libs\.versions\.toml|\.pro$|AndroidManifest\.xml|/res/|/assets/'; then
            echo "relevant_changes=true" >> $GITHUB_OUTPUT
            echo "‚úì Found changes that may affect APK size"
          else
            echo "relevant_changes=false" >> $GITHUB_OUTPUT
            echo "‚Ñπ No changes that affect APK size detected"
          fi

      - name: Skip analysis notification
        if: steps.changed-files.outputs.relevant_changes != 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## üìä APK Size Analysis
            
            ‚è≠Ô∏è Skipped - No files that affect APK size were changed in this PR.
            
            This workflow runs for changes to: Kotlin files, Gradle configuration, resources, manifests, and assets.
            
            ---
            _Generated by [Diffuse](https://github.com/JakeWharton/diffuse) via [diffuse-action](https://github.com/usefulness/diffuse-action)_

      - name: Set up JDK 23
        if: steps.changed-files.outputs.relevant_changes == 'true'
        uses: actions/setup-java@v5
        with:
          java-version: '23'
          distribution: 'temurin'

      - name: Setup Gradle
        if: steps.changed-files.outputs.relevant_changes == 'true'
        uses: gradle/actions/setup-gradle@v5

      # Build PR APK
      - name: Build PR APK
        if: steps.changed-files.outputs.relevant_changes == 'true'
        run: ./gradlew assembleRelease --parallel --daemon

      - name: List APK outputs
        if: steps.changed-files.outputs.relevant_changes == 'true'
        run: |
          echo "Listing APK outputs:"
          find app/build/outputs/apk -name "*.apk"

      # Download base APK from latest release
      - name: Download base APK from latest release
        if: steps.changed-files.outputs.relevant_changes == 'true'
        run: |
          # Get latest release info
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest)
          
          # Extract APK download URL
          APK_URL=$(echo "$LATEST_RELEASE" | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url')
          
          if [ -z "$APK_URL" ]; then
            echo "Error: No APK found in latest release"
            exit 1
          fi
          
          echo "Downloading base APK from: $APK_URL"
          curl -L -o base.apk "$APK_URL"

      # Run Diffuse comparison using the action
      - name: Run Diffuse
        if: steps.changed-files.outputs.relevant_changes == 'true'
        id: diffuse
        uses: usefulness/diffuse-action@v1
        continue-on-error: true
        with:
          old-file-path: base.apk
          new-file-path: app/build/outputs/apk/release/app-release.apk

      # Post or update comment on PR
      - name: Find existing Diffuse comment
        if: steps.changed-files.outputs.relevant_changes == 'true'
        uses: peter-evans/find-comment@v3
        id: find_comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: 'üìä APK Size Analysis'

      - name: Create or update PR comment
        if: steps.changed-files.outputs.relevant_changes == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            ## üìä APK Size Analysis
            
            Comparing `${{ github.base_ref }}` (latest release) ‚Üí `${{ github.head_ref }}` (this PR)
            
            ${{ steps.diffuse.outputs.diff-gh-comment || '‚ö†Ô∏è Diffuse analysis failed. Check the workflow logs for details.' }}
            
            ---
            _Generated by [Diffuse](https://github.com/JakeWharton/diffuse) via [diffuse-action](https://github.com/usefulness/diffuse-action)_

      # Upload APKs as artifacts for manual inspection
      - name: Upload APKs
        if: steps.changed-files.outputs.relevant_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: apks-comparison
          path: |
            base.apk
            app/build/outputs/apk/release/app-release.apk
          retention-days: 7

