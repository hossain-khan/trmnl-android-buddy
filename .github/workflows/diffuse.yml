name: APK Size Analysis with Diffuse

on:
  pull_request:
    branches: [ "main" ]

jobs:
  diffuse:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # Required to post comments

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v5

      - name: Set up JDK 23
        uses: actions/setup-java@v5
        with:
          java-version: '23'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      # Build PR APK
      - name: Build PR APK
        run: ./gradlew assembleRelease --parallel --daemon

      - name: List APK outputs
        run: |
          echo "Listing APK outputs:"
          find app/build/outputs/apk -name "*.apk"

      # Download base APK from latest release
      - name: Download base APK from latest release
        run: |
          # Get latest release info
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest)
          
          # Extract APK download URL
          APK_URL=$(echo "$LATEST_RELEASE" | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url')
          
          if [ -z "$APK_URL" ]; then
            echo "Error: No APK found in latest release"
            exit 1
          fi
          
          echo "Downloading base APK from: $APK_URL"
          curl -L -o base.apk "$APK_URL"

      # Run Diffuse comparison using the action
      - name: Run Diffuse
        id: diffuse
        uses: usefulness/diffuse-action@v1
        continue-on-error: true
        with:
          old-file-path: base.apk
          new-file-path: app/build/outputs/apk/release/app-release.apk

      # Post or update comment on PR
      - name: Find existing Diffuse comment
        uses: peter-evans/find-comment@v3
        id: find_comment
        if: success() || failure()
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: 'üìä APK Size Analysis'

      - name: Create or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        if: always()
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            ## üìä APK Size Analysis
            
            Comparing `${{ github.base_ref }}` (latest release) ‚Üí `${{ github.head_ref }}` (this PR)
            
            ${{ steps.diffuse.outputs.diff-gh-comment || '‚ö†Ô∏è Diffuse analysis failed. Check the workflow logs for details.' }}
            
            ---
            _Generated by [Diffuse](https://github.com/JakeWharton/diffuse) via [diffuse-action](https://github.com/usefulness/diffuse-action)_

      # Upload APKs as artifacts for manual inspection
      - name: Upload APKs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: apks-comparison
          path: |
            base.apk
            app/build/outputs/apk/release/app-release.apk
          retention-days: 7

